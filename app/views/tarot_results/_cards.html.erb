<% result_cards = TarotResultCard.includes(:tarot_card).where(tarot_result_id: tarot_result.id).order(:position) %>
<% max_cards = tarot_result.max_cards %>

<%= render "shared/card",
      title: "üÉè Âºï„ÅÑ„Åü„Ç´„Éº„Éâ",
      subtitle: "ÊúÄÂ§ß#{max_cards}Êûö„Åæ„ÅßÂºï„Åë„Åæ„Åô" do %>

  <% cols =
    case max_cards
    when 1 then "grid-cols-1"
    when 2 then "grid-cols-1 sm:grid-cols-2"
    else        "grid-cols-1 sm:grid-cols-3"
    end
  %>

  <div class="grid <%= cols %> gap-4">
    <% result_cards.each do |result_card| %>
      <% orientation = result_card.orientation.to_s %>
      <% is_reversed = (orientation == "reversed") %>
      <% card = result_card.tarot_card %>

      <%# --- seeds„ÅÆÂ±ûÊÄßÔºàarcana/suitÔºâ„Çí„É©„Éô„É´Âåñ --- %>
      <% arcana_label =
          if card&.respond_to?(:arcana) && card.arcana.present?
            card.arcana.to_s == "major" ? "Â§ß„Ç¢„É´„Ç´„Éä" : "Â∞è„Ç¢„É´„Ç´„Éä"
          else
            "‚Äî"
          end
      %>

      <% suit_label =
          case card&.suit.to_s
          when "wand"      then "„ÉØ„É≥„Éâ"
          when "cup"       then "„Ç´„ÉÉ„Éó"
          when "sword"     then "„ÇΩ„Éº„Éâ"
          when "pentacle"  then "„Éö„É≥„Çø„ÇØ„É´"
          else ""
          end
      %>

      <%# --- seeds„ÅÆÊÉÖÂ†±„Åã„Çâ„Ç≠„Éº„ÉØ„Éº„Éâ„Çí‰Ωú„ÇãÔºàÂõ∫ÂÆöÈÖçÂàó„Çí„ÇÑ„ÇÅ„ÇãÔºâ --- %>
      <% keywords = [] %>
      <% if card.present? %>
        <% if card.respond_to?(:arcana) && card.arcana.to_s == "major" %>
          <% keywords << "Â§ß„Ç¢„É´„Ç´„Éä" %>
        <% elsif card.respond_to?(:arcana) && card.arcana.to_s == "minor" %>
          <% keywords << "Â∞è„Ç¢„É´„Ç´„Éä" %>
        <% end %>

        <% if suit_label.present? %>
          <% keywords << suit_label %>
        <% end %>

        <%# Âêë„ÅçÔºàÊ≠£/ÈÄÜÔºâ„ÇíË£úÂä©„Çø„Ç∞„Å´„Åô„Çã %>
        <% keywords << (is_reversed ? "ÂÜÖÁúÅ" : "Â§ñÂêë„Åç") %>
      <% end %>

      <div class="rounded-2xl bg-white ring-1 ring-gray-200 p-4 shadow-sm
                  hover:shadow-md hover:-translate-y-0.5 transition">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <p class="text-xs text-gray-500"><%= result_card.position %>ÊûöÁõÆ</p>

            <p class="mt-2 font-semibold text-gray-900">
              <%= card&.name || "Ôºà„Ç´„Éº„ÉâÂêç‰∏çÊòéÔºâ" %>
            </p>

            <%# Â§ß/Â∞è + „Çπ„Éº„ÉàÔºàÂ∞è„Ç¢„É´„Ç´„Éä„ÅÆ„ÅøÔºâ %>
            <p class="mt-1 text-xs text-gray-500">
              <%= arcana_label %><%= suit_label.present? ? "„Éª#{suit_label}" : "" %>
            </p>
          </div>

          <span class="shrink-0 inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1
            <%= is_reversed ? "bg-rose-50 text-rose-700 ring-rose-200" : "bg-emerald-50 text-emerald-700 ring-emerald-200" %>">
            <%= is_reversed ? "ÈÄÜ‰ΩçÁΩÆ" : "Ê≠£‰ΩçÁΩÆ" %>
          </span>
        </div>

        <p class="mt-2 text-sm text-gray-600 leading-relaxed line-clamp-5">
          <%= card&.meaning.presence || "ÔºàÊÑèÂë≥„ÅåÊú™ÁôªÈå≤„Åß„ÅôÔºâ" %>
        </p>

        <% if keywords.any? %>
          <div class="mt-3 flex flex-wrap gap-2">
            <% keywords.each do |kw| %>
              <span class="inline-flex items-center rounded-full bg-gray-50 px-2.5 py-1 text-xs text-gray-700 ring-1 ring-gray-200">
                <%= kw %>
              </span>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <% remaining = max_cards - result_cards.size %>
    <% remaining.times do |i| %>
      <div class="rounded-2xl border border-dashed border-gray-300 p-4 bg-gray-50/60">
        <p class="text-xs text-gray-500"><%= result_cards.size + i + 1 %>ÊûöÁõÆ</p>
        <p class="mt-2 font-semibold text-gray-400">„Åæ„Å†Âºï„ÅÑ„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
        <p class="mt-2 text-sm text-gray-400 leading-relaxed">
          Ê¨°„ÅÆ„Ç´„Éº„Éâ„ÇíÂºï„Åè„Å®„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô
        </p>
      </div>
    <% end %>
  </div>

<% end %>
